###################################################################
# File Name: filter_SV_vcf.py
# Author: yaomingyue
# mail: yaomingyue@fuanhua.com
# Created Time: 2017年09月14日 星期四 15时58分10秒
#=============================================================
'''The script was used to filter the vcf generated by Delly!'''
#!/usr/bin/env python
#-*- coding:utf8 -*-
import argparse
import re

def filter_sv_vcf(input_vcf,output_vcf,mapq,sr,pe):
	for line in input_vcf:
		if line.startswith("#"):
			output_vcf.write(line)
		else:
			tmps=line.strip().split()
			if tmps[6]!="PASS":continue
			MAPQ=re.search("MAPQ=(\d+)",tmps[7])
			if MAPQ:
				if int(MAPQ.group(1))>=mapq:
					if tmps[7].find("IMPRECISE")!=-1:
						PE=re.search("PE=(\d+)",tmps[7])
						if PE:
							if int(PE.group(1))>=pe:
								output_vcf.write(line)
						else:
							print("No PE in"+line,end="")
							exit(1)
					else:
						SR=re.search("SR=(\d+)",tmps[7])
						if SR:
							if int(SR.group(1))>=pe:
								output_vcf.write(line)
							else:
								print("No SR in"+line,end="")
							exit(1)

def main():
	parser=argparse.ArgumentParser(description=__doc__)
	parser.add_argument('-i','--input',help='the vcf which generated by Delly',dest='vcf',required=True,type=open)
	parser.add_argument('-o','--output',help='the filtered vcf',dest='output',required=True,type=argparse.FileType('w'))
	parser.add_argument('-q','--mapq',help="the SV value for filter",dest='mapq',default=20,type=int)
	parser.add_argument('-pe',help="the num of support PE which was used for IMPRECISE",dest='pe',default=4,type=int)
	parser.add_argument('-sr',help="the num of Split Read which was used for PRECISE",dest='sr',default=4,type=int)
	args=parser.parse_args()
	filter_sv_vcf(args.vcf,args.output,args.mapq,args.sr,args.pe)
if __name__=="__main__":
	main()
